ARG PYTHON_VERSION=3.7

FROM python:${PYTHON_VERSION}-slim-bullseye AS builder

WORKDIR /work
COPY LICENSE /work/LICENSE
COPY MANIFEST.in /work/MANIFEST.in
COPY README.md /work/README.md
COPY pyproject.toml /work/pyproject.toml
COPY src/ /work/src/


RUN python3 -m pip install --no-cache-dir poetry && \
    poetry build .

FROM python:${PYTHON_VERSION}-slim-bullseye as runtime

RUN useradd {{ cookiecutter.project_name }}
WORKDIR /home/{{ cookiecutter.project_name }}/app

COPY --from=builder /work/dist/{{ cookiecutter.project_name }}*.whl /home/{{ cookiecutter.project_name }}/app

RUN chown -R {{ cookiecutter.project_name }}:{{ cookiecutter.project_name }} /home/{{ cookiecutter.project_name }}
USER {{ cookiecutter.project_name }}:{{ cookiecutter.project_name }}
ENV PATH=${PATH}:/home/{{ cookiecutter.project_name }}/.local/bin

RUN python3 -m pip install \
    --user \
    --no-cache-dir \
    --no-warn-script-location \
    /home/{{ cookiecutter.project_name }}/app/{{ cookiecutter.package_name }}*.whl && \
    rm /home/{{ cookiecutter.project_name }}/app/*.whl

CMD ["{{ cookiecutter.project_name }}"]
